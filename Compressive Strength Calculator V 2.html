<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compressive Strength Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, getDocs, query, where, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        window.firebase = { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, doc, setDoc, getDoc, collection, getDocs, query, where, Timestamp, setLogLevel };

        window.runApplication = mainAppLogic;
        window.onload = () => {
            window.runApplication();
        };

    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .data-input { transition: all 0.2s; }
        .data-input:focus { box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5); }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background-color: #60a5fa; border-radius: 2px; }
        ::-webkit-scrollbar-track { background-color: #f3f4f6; }
        .summary-table th, .summary-table td { padding: 8px 6px; white-space: nowrap; text-align: center; }
        .summary-table th { background-color: #e5e7eb; font-size: 0.75rem; }
        .pwd-checkbox { appearance: none; width: 1.5rem; height: 1.5rem; border: 2px solid #9ca3af; border-radius: 0.375rem; display: inline-block; vertical-align: middle; position: relative; cursor: pointer; transition: background-color 0.2s; }
        .pwd-checkbox:checked { background-color: #3b82f6; border-color: #3b82f6; }
        .pwd-checkbox:checked::after { content: '✔'; color: white; font-size: 1rem; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-2 md:p-8">

    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 transition-opacity duration-300">
        <div class="flex flex-col items-center">
            <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-white mb-4"></div>
            <p class="text-white text-lg">Initializing App...</p>
        </div>
    </div>

    <div id="app-container" class="max-w-xl mx-auto bg-white shadow-2xl rounded-xl p-4 md:p-6 transition-all duration-300">
        <h1 class="text-3xl font-extrabold text-gray-900 mb-6 border-b pb-3 text-center">Compressive Strength Calculator</h1>

        <div class="flex justify-around mb-6 text-sm font-medium">
            <button id="nav-step1" class="p-2 w-1/3 text-center rounded-l-lg transition-colors duration-200 bg-blue-500 text-white shadow-md">1. Project Details</button>
            <button id="nav-step2" class="p-2 w-1/3 text-center transition-colors duration-200 bg-gray-200 text-gray-500 hover:bg-gray-300" disabled>2. Cube Data</button>
            <button id="nav-step3" class="p-2 w-1/3 text-center rounded-r-lg transition-colors duration-200 bg-gray-200 text-gray-500 hover:bg-gray-300" disabled>3. Summary</button>
        </div>

        <div id="modal-container" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center z-40">
            <div id="modal-content" class="bg-white p-6 rounded-lg shadow-xl max-w-sm mx-4 transform transition-all duration-300 scale-95 opacity-0">
                <h3 id="modal-title" class="text-xl font-bold mb-3 text-red-600">Warning!</h3>
                <p id="modal-message" class="text-gray-700 mb-6"></p>
                <div class="flex justify-end space-x-3">
                    <button id="modal-cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition-colors">Cancel</button>
                    <button id="modal-confirm-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">Proceed Anyway</button>
                </div>
            </div>
        </div>

        <div id="screen1" class="space-y-4">
            <h2 class="text-xl font-semibold text-gray-700">Test Information</h2>
            <div class="flex space-x-2 text-xs">
                <span class="p-1 bg-gray-100 rounded-lg text-gray-600">App ID: <span id="display-app-id" class="font-mono"></span></span>
                <span class="p-1 bg-gray-100 rounded-lg text-gray-600">User ID: <span id="display-user-id" class="font-mono">Loading...</span></span>
            </div>
	    <div>
                <label for="ref-no" class="block text-sm font-medium text-gray-700">Reference No.</label>
                <input type="text" id="ref-no" placeholder="Reference" class="data-input mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:border-blue-500">
            </div>
	    <div>
                <label for="client-name" class="block text-sm font-medium text-gray-700">Client Name</label>
                <input type="text" id="client-name" placeholder="Client" class="data-input mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:border-blue-500">
            </div>

            <div>
                <label for="project-name" class="block text-sm font-medium text-gray-700">Project Name</label>
                <input type="text" id="project-name" placeholder="General Civil Work" class="data-input mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:border-blue-500">
            </div>
            <div>
                <label for="location" class="block text-sm font-medium text-gray-700">Location</label>
                <input type="text" id="location" placeholder="Slab A1P2" class="data-input mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:border-blue-500">
            </div>
            <div class="flex space-x-4">
                <div class="w-1/2">
                    <label for="concrete-grade" class="block text-sm font-medium text-gray-700">Grade (N/mm²)</label>
                    <input type="number" id="concrete-grade" min="10" placeholder="30" class="data-input mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3">
                </div>
                <div class="w-1/2">
                    <label for="mix-type" class="block text-sm font-medium text-gray-700">Type of Mix</label>
                    <select id="mix-type" class="data-input mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 appearance-none bg-white">
                        <option value="RMC">Ready Mix Concrete (RMC)</option>
                        <option value="Site">Site Mix</option>
                    </select>
                </div>
            </div>
            <div class="flex space-x-4">
                <div class="w-1/2">
                    <label for="quantity" class="block text-sm font-medium text-gray-700">Quantity (m³)</label>
                    <input type="number" id="quantity" min="1" placeholder="95" class="data-input mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3">
                    <p id="min-samples-info" class="text-xs text-gray-500 mt-1"></p>
                </div>
                <div class="w-1/2">
                    <label for="num-samples" class="block text-sm font-medium text-gray-700">Number of Samples</label>
                    <input type="number" id="num-samples" min="1" placeholder="5" class="data-input mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3">
                </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label for="date-casting" class="block text-sm font-medium text-gray-700">Date of Casting (DD/MM/YYYY)</label>
                    <input type="text" id="date-casting" placeholder="DD/MM/YYYY" class="data-input mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3">
                </div>
                <div>
                    <label for="date-testing" class="block text-sm font-medium text-gray-700">Date of Testing (DD/MM/YYYY)</label>
                    <input type="text" id="date-testing" placeholder="DD/MM/YYYY" class="data-input mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3">
                </div>
            </div>
            <div class="mt-4 p-3 bg-blue-50 rounded-lg">
                <p class="text-sm font-medium text-blue-700">Age of Specimen: <span id="age-specimen" class="font-bold text-base">0</span> Days</p>
            </div>
            <div class="space-y-3 p-4 bg-gray-100 rounded-lg border border-gray-200">
                <h3 class="text-lg font-semibold text-gray-800">Reference Standards</h3>
                <div>
                    <label for="reference-standard" class="block text-sm font-medium text-gray-700">Primary Standard</label>
                    <select id="reference-standard" class="data-input mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 appearance-none bg-white">
                        <option value="IS 456:2000">IS 456:2000</option>
                        <option value="IRC 112:2020">IRC 112:2020</option>
                    </select>
                </div>
                <div class="flex items-center space-x-3 mt-3">
                    <input type="checkbox" id="is-pwd-work" class="pwd-checkbox">
                    <label for="is-pwd-work" class="text-sm font-medium text-gray-700 cursor-pointer">Kerala PWD Work? (Applies TC CE/DESIGN/QC/15/2019 dated 16/05/2019)</label>
                </div>
            </div>
            <div class="pt-4 flex justify-between space-x-3">
                <button id="load-data-btn" class="flex-1 px-4 py-3 bg-gray-200 text-gray-800 rounded-lg font-semibold hover:bg-gray-300" disabled>Load Saved Data</button>
                <button id="save-data-btn1" class="flex-1 px-4 py-3 bg-green-500 text-white rounded-lg font-semibold hover:bg-green-600 shadow-md" disabled>Save Progress</button>
                <button id="next-screen-btn" class="flex-1 px-4 py-3 bg-blue-500 text-white rounded-lg font-semibold hover:bg-blue-600 shadow-md" disabled>Proceed to Data</button>
            </div>
        </div>

        <div id="screen2" class="hidden space-y-4">
            <h2 class="text-xl font-semibold text-gray-700">Sample Data Input (<span id="total-cubes">0</span> Cubes Total)</h2>
            <div id="samples-container" class="space-y-6"></div>
            <div id="results-card" class="hidden p-4 bg-gray-100 rounded-xl shadow-inner space-y-3">
                <h3 class="text-lg font-bold text-gray-800 border-b pb-2">Test Results Summary</h3>
                <p class="text-sm">Mean Strength (Accepted): <span id="results-card-mean-strength" class="font-semibold text-base text-blue-600">0.00</span> N/mm²</p>
                <p class="text-sm">Min Strength (Accepted): <span id="results-card-min-strength" class="font-semibold text-base text-blue-600">0.00</span> N/mm²</p>
                <p class="text-sm">Standard Deviation (IS 456): <span id="results-card-sd" class="font-semibold text-base">0</span> N/mm²</p>
                <div class="mt-3 pt-3 border-t">
                    <p class="text-base font-medium text-gray-700"><span id="results-card-required-mean-label">Required Mean Strength</span>: <span id="results-card-required-mean" class="font-bold text-green-700">0.00</span> N/mm²</p>
                    <p class="text-base font-medium text-gray-700"><span id="results-card-required-min-label">Required Min Strength</span>: <span id="results-card-required-min" class="font-bold text-green-700">0.00</span> N/mm²</p>
                </div>
                <div id="results-card-verdict-container" class="mt-3 pt-3 border-t">
                    <p class="text-xl font-extrabold">Test Verdict: <span id="results-card-final-verdict" class="text-red-500">PENDING</span></p>
                </div>
            </div>
            <div class="pt-4 flex flex-col space-y-3">
                <button id="calculate-results-btn" class="w-full px-4 py-4 bg-green-600 text-white rounded-lg font-extrabold text-lg hover:bg-green-700 shadow-xl">CALCULATE & VIEW SUMMARY (STEP 3)</button>
                <div class="flex space-x-3">
                    <button id="back-screen-btn" class="w-1/2 px-4 py-3 bg-gray-400 text-white rounded-lg font-semibold hover:bg-gray-500">Back to Details (Step 1)</button>
                    <button id="save-data-btn2" class="w-1/2 px-4 py-3 bg-green-500 text-white rounded-lg font-semibold hover:bg-green-600 shadow-md" disabled>Save Progress</button>
                </div>
            </div>
        </div>
        
        <div id="screen3" class="hidden space-y-6">
            <h2 class="text-2xl font-bold text-gray-900 border-b pb-3">Final Compressive Test Report Summary</h2>
            <div class="p-4 bg-blue-50 border border-blue-200 rounded-xl space-y-2 shadow-inner">
                <h3 class="text-xl font-semibold text-blue-800 border-b pb-1">Project Information</h3>
                <div class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
                    <p><strong>Reference No.:</strong> <span id="sum-ref-no"></span></p>
                    <p><strong>Client:</strong> <span id="sum-client-name"></span></p>
		    <p><strong>Project:</strong> <span id="sum-project-name"></span></p>
                    <p><strong>Location:</strong> <span id="sum-location"></span></p>
                    <p><strong>Grade:</strong> <span id="sum-concrete-grade"></span> N/mm²</p>
                    <p><strong>Mix Type:</strong> <span id="sum-mix-type"></span></p>
                    <p><strong>Quantity:</strong> <span id="sum-quantity"></span> m³</p>
                    <p><strong>Samples:</strong> <span id="sum-num-samples"></span></p>
                    <p><strong>Date Cast:</strong> <span id="sum-date-casting"></span></p>
                    <p><strong>Date Test:</strong> <span id="sum-date-testing"></span></p>
                    <p class="col-span-2 text-base pt-2"><strong>Specimen Age:</strong> <span id="sum-age-specimen" class="font-bold text-blue-700"></span> Days</p>
                    <p class="col-span-2 pt-2"><strong>References:</strong> <span id="sum-references" class="font-medium"></span></p>
                </div>
            </div>
            <div class="p-4 bg-green-50 border border-green-200 rounded-xl space-y-3 shadow-lg">
                <h3 class="text-xl font-semibold text-green-800 border-b pb-1">Acceptance & Strength Results</h3>
                <div class="grid grid-cols-2 gap-4 text-sm font-medium">
                    <div class="p-3 bg-white rounded-lg border">
                        <p class="text-xs text-gray-500" id="sum-card-required-mean-label">Required Mean Strength</p>
                        <p class="text-lg font-extrabold text-green-700"><span id="sum-card-required-mean">0.00</span> N/mm²</p>
                    </div>
                    <div class="p-3 bg-white rounded-lg border">
                        <p class="text-xs text-gray-500">Observed Mean Strength</p>
                        <p class="text-lg font-extrabold text-blue-700"><span id="sum-card-mean-strength">0.00</span> N/mm²</p>
                    </div>
                    <div class="p-3 bg-white rounded-lg border">
                        <p class="text-xs text-gray-500" id="sum-card-required-min-label">Required Min Strength</p>
                        <p class="text-lg font-extrabold text-green-700"><span id="sum-card-required-min">0.00</span> N/mm²</p>
                    </div>
                    <div class="p-3 bg-white rounded-lg border">
                        <p class="text-xs text-gray-500">Observed Min Strength</p>
                        <p class="text-lg font-extrabold text-blue-700"><span id="sum-card-min-strength">0.00</span> N/mm²</p>
                    </div>
                </div>
                <div class="p-4 rounded-lg text-center mt-4" id="sum-card-verdict-container">
                    <p class="text-2xl font-extrabold">Final Verdict: <span id="sum-card-final-verdict" class="text-red-500">PENDING</span></p>
                </div>
            </div>
            <div class="p-4 bg-gray-100 rounded-xl shadow-md overflow-x-auto">
                <h3 class="text-xl font-semibold text-gray-700 border-b pb-1 mb-3">Cube Data & Calculation Trace</h3>
                <table id="sum-data-table" class="summary-table w-full text-xs border-collapse">
                    <thead>
                        <tr>
                            <th class="sticky left-0 bg-gray-300">Sample</th>
                            <th>Cube ID</th>
                            <th>L (mm)</th><th>B (mm)</th><th>H (mm)</th>
                            <th>Weight (kg)</th><th>Load (kN)</th>
                            <th class="bg-yellow-200">Density (g/cm³)</th>
                            <th class="bg-yellow-200">Strength (N/mm²)</th>
                            <th class="bg-yellow-200">% Var</th>
                            <th class="bg-blue-200">Avg Strength</th>
                            <th class="bg-blue-200">Acceptable</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="pt-4 flex flex-col space-y-3">
                <button id="export-pdf-btn3" class="w-full px-4 py-4 bg-red-600 text-white rounded-lg font-extrabold text-lg hover:bg-red-700 shadow-xl" disabled>Generate PDF Report</button>
                <button id="back-screen2-btn" class="w-full px-4 py-3 bg-gray-400 text-white rounded-lg font-semibold hover:bg-gray-500">Back to Data Input (Step 2)</button>
            </div>
        </div>
        
        <footer class="mt-8 pb-4 text-center text-sm text-red-600">
            <p>Conceived and developed by Vaisakh G.</p>
            <p>Queries and suggestions: WhatsApp 9656840794</p>
        </footer>
    </div>

    <script>
    function mainAppLogic() {
        let app = null, db = null, auth = null, userId = 'loading', isAuthReady = false, pdfLibrariesReady = false;
        const CUBE_DEFAULT_DIMENSION = 150, DATA_PATH = 'public/data/cube_test_reports';

        const state = {
            currentPage: 1, refNo: '', clientName: '',  projectName: '', location: '', concreteGrade: 30, mixType: 'RMC', quantity: 95, numSamples: 5, dateCasting: '', dateTesting: '', ageSpecimen: 0,
            referenceStandard: 'IS 456:2000', isPwdWork: false, samples: [], meanStrength: 0, minStrength: 0, sd: 0, requiredMean: 0, requiredMin: 0, verdict: 'PENDING'
        };
        
        function checkPdfLibraries() {
            try {
                if (window.jspdf && window.jspdf.jsPDF && typeof (new window.jspdf.jsPDF()).autoTable === 'function') {
                    pdfLibrariesReady = true;
                    if (state.currentPage === 3) updateScreen3UI();
                } else { setTimeout(checkPdfLibraries, 500); }
            } catch (e) { setTimeout(checkPdfLibraries, 500); }
        }

        function parseDate(s) {
            if (!s) return null;
            const p = s.split('/');
            if (p.length === 3) {
                const d = parseInt(p[0], 10), m = parseInt(p[1], 10) - 1, y = parseInt(p[2], 10);
                if (isNaN(d) || isNaN(m) || isNaN(y) || y < 1900 || y > 2100) return null;
                const date = new Date(Date.UTC(y, m, d));
                return (date.getUTCFullYear() === y && date.getUTCMonth() === m && date.getUTCDate() === d) ? date : null;
            }
            return null;
        }

        function formatDate(d) {
            return `${String(d.getDate()).padStart(2, '0')}/${String(d.getMonth() + 1).padStart(2, '0')}/${d.getFullYear()}`;
        }

        function calculateMinSamples(q) {
            const Q = parseFloat(q);
            if (isNaN(Q) || Q <= 0) return 1;
            if (Q <= 5) return 1; if (Q <= 15) return 2; if (Q <= 30) return 3; if (Q <= 50) return 4;
            return 4 + Math.ceil((Q - 50) / 50);
        }

        function updateAgeSpecimen() {
            const cast = parseDate(state.dateCasting), test = parseDate(state.dateTesting);
            if (cast && test) {
                state.ageSpecimen = Math.ceil(Math.abs(test.getTime() - cast.getTime()) / (1000 * 60 * 60 * 24));
            } else { state.ageSpecimen = 0; }
            document.getElementById('age-specimen').textContent = state.ageSpecimen;
        }

        function setDefaultDates() {
            const today = new Date(), past = new Date(today);
            past.setDate(today.getDate() - 28);
            state.dateTesting = formatDate(today); state.dateCasting = formatDate(past);
            document.getElementById('date-testing').value = state.dateTesting;
            document.getElementById('date-casting').value = state.dateCasting;
            updateAgeSpecimen();
        }

        function calculateSampleMetrics(idx) {
            const sample = state.samples[idx]; if (!sample) return;
            const strengths = sample.cubes.map(c => {
                const area = c.L * c.B;
                c.strength = (area > 0 && c.Load > 0) ? (c.Load * 1000) / area : 0;
                c.density = (area * c.H > 0 && c.W > 0) ? (c.W * 1000) / (area * c.H / 1000) : 0;
                return c.strength;
            }).filter(s => s > 0);

            sample.avgStrength = strengths.length === 3 ? strengths.reduce((a, b) => a + b) / 3 : 0;
            sample.acceptable = sample.avgStrength > 0;
            sample.cubes.forEach(c => {
                c.percentVariation = sample.avgStrength > 0 ? ((c.strength - sample.avgStrength) / sample.avgStrength) * 100 : 0;
                if (Math.abs(c.percentVariation) > 15) sample.acceptable = false;
            });

            const avgEl = document.getElementById(`sample-avg-${idx}`), accEl = document.getElementById(`sample-acceptable-${idx}`);
            if (avgEl) avgEl.textContent = sample.avgStrength.toFixed(2);
            if (accEl) { accEl.textContent = sample.acceptable ? 'Yes' : 'No'; accEl.className = `font-bold ${sample.acceptable ? 'text-green-600' : 'text-red-600'}`; }
            sample.cubes.forEach((c, cidx) => {
                const prefix = `cube-${idx}-${cidx}`;
                const d = document.getElementById(`${prefix}-density`), s = document.getElementById(`${prefix}-strength`), v = document.getElementById(`${prefix}-p-variation`);
                if (d) d.textContent = c.density.toFixed(2); if (s) s.textContent = c.strength.toFixed(2); if (v) v.textContent = `${c.percentVariation.toFixed(2)}%`;
            });
        }

        function handleCubeInput(sIdx, cIdx, field, val) {
            const cube = state.samples[sIdx].cubes[cIdx];
            if (field === 'ID') cube.id = String(val); else cube[field] = parseFloat(val) || 0;
            calculateSampleMetrics(sIdx);
        }

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;

        async function initializeFirebase() {
            try {
                if (firebaseConfig && window.firebase) {
                    app = window.firebase.initializeApp(firebaseConfig); db = window.firebase.getFirestore(app); auth = window.firebase.getAuth(app);
                    let user = (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) ? 
                        (await window.firebase.signInWithCustomToken(auth, __initial_auth_token)).user : (await window.firebase.signInAnonymously(auth)).user;
                    userId = user.uid; document.getElementById('display-app-id').textContent = appId; document.getElementById('display-user-id').textContent = userId;
                    isAuthReady = true; enableButtons(); hideLoading(); loadState(true);
                } else { enableButtons(); hideLoading(); }
            } catch (e) { hideLoading(); enableButtons(); }
        }

        async function saveState() {
            if (!db || !isAuthReady) return showToast('Auth not ready', 'red');
            try {
                state.samples.forEach((_, i) => calculateSampleMetrics(i));
                await window.firebase.setDoc(window.firebase.doc(db, 'artifacts', appId, DATA_PATH, userId), JSON.parse(JSON.stringify(state)), { merge: true });
                showToast('Data saved!', 'green');
            } catch (e) { showToast('Save error', 'red'); }
        }

        async function loadState(silent = false) {
            if (!db || !isAuthReady) return;
            try {
                const snap = await window.firebase.getDoc(window.firebase.doc(db, 'artifacts', appId, DATA_PATH, userId));
                if (snap.exists()) {
                    Object.assign(state, snap.data()); updateScreen1UI(); updateScreen2UI(true);
                    if (state.currentPage === 3) calculateFinalResults(true);
                    navigateTo(state.currentPage); if (!silent) showToast('Loaded!', 'green');
                } else if (!silent) setDefaultDates();
            } catch (e) { if (!silent) showToast('Load error', 'red'); }
        }

        function enableButtons() { 
            ['load-data-btn', 'save-data-btn1', 'next-screen-btn', 'save-data-btn2'].forEach(id => {
                const el = document.getElementById(id); if (el) el.disabled = false;
            });
        }
        function showLoading() { document.getElementById('loading-overlay').classList.remove('hidden'); }
        function hideLoading() { document.getElementById('loading-overlay').classList.add('hidden'); }
        function showToast(msg, color = 'blue') {
            let t = document.getElementById('toast');
            if (!t) { t = document.createElement('div'); t.id = 'toast'; t.className = 'fixed bottom-4 left-1/2 -translate-x-1/2 px-6 py-3 rounded-full text-white shadow-xl transition-opacity opacity-0 z-50'; document.body.appendChild(t); }
            t.className = t.className.replace(/bg-\w+-\d+/, '') + ` bg-${color}-500`; t.textContent = msg;
            setTimeout(() => t.classList.remove('opacity-0'), 50); setTimeout(() => t.classList.add('opacity-0'), 3000);
        }

        function updateScreen1UI() {
            ['ref-no','client-name', 'project-name', 'location', 'concrete-grade', 'mix-type', 'quantity', 'num-samples', 'date-casting', 'date-testing', 'reference-standard'].forEach(id => {
                const field = id.replace(/-([a-z])/g, g => g[1].toUpperCase());
                document.getElementById(id).value = state[field];
            });
            document.getElementById('is-pwd-work').checked = state.isPwdWork;
            updateMinSamplesInfo(); updateAgeSpecimen();
        }

        function updateMinSamplesInfo() { document.getElementById('min-samples-info').textContent = `Minimum required: ${calculateMinSamples(state.quantity)}`; }

        function navigateTo(num) {
            state.currentPage = num;
            [1, 2, 3].forEach(n => {
                document.getElementById(`screen${n}`).classList.toggle('hidden', num !== n);
                document.getElementById(`nav-step${n}`).className = `p-2 w-1/3 text-center transition-colors shadow-md ${num === n ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-500'}`;
            });
            document.getElementById('nav-step1').classList.add('rounded-l-lg'); document.getElementById('nav-step3').classList.add('rounded-r-lg');
            document.getElementById('nav-step2').disabled = state.numSamples < 1;
            document.getElementById('nav-step3').disabled = state.verdict === 'PENDING';
            if (num === 3) updateScreen3UI();
        }

        function updateScreen2UI(recalc = false) {
            const container = document.getElementById('samples-container'); container.innerHTML = '';
            document.getElementById('total-cubes').textContent = state.numSamples * 3;
            while (state.samples.length < state.numSamples) {
                state.samples.push({ cubes: Array(3).fill(null).map((_, i) => ({ id: `Cube ${i + 1}`, L: 150, B: 150, H: 150, W: 0, Load: 0, density: 0, strength: 0, percentVariation: 0 })), avgStrength: 0, acceptable: false });
            }
            state.samples.length = state.numSamples;
            state.samples.forEach((s, sIdx) => {
                const div = document.createElement('div'); div.className = 'border border-blue-200 p-4 rounded-xl bg-white shadow-md space-y-3';
                div.innerHTML = `<h3 class="text-lg font-bold text-blue-700 border-b pb-2">Sample ${sIdx + 1}</h3><div class="grid grid-cols-2 gap-4 p-2 bg-blue-50 rounded-lg text-sm font-semibold"><p>Avg: <span id="sample-avg-${sIdx}">0</span></p><p>Accept: <span id="sample-acceptable-${sIdx}">No</span></p></div><div class="space-y-4" id="sample-cubes-${sIdx}"></div>`;
                container.appendChild(div);
                s.cubes.forEach((c, cIdx) => {
                    const cubeDiv = document.createElement('div'); cubeDiv.className = 'border p-3 rounded-lg bg-gray-50 space-y-2';
                    cubeDiv.innerHTML = `<h4 class="font-semibold">Cube ${cIdx + 1}</h4><div class="grid grid-cols-2 gap-3 text-xs"><label>ID<input type="text" id="cube-${sIdx}-${cIdx}-id" value="${c.id}" class="w-full border p-1 rounded"></label><label>Load (kN)<input type="number" id="cube-${sIdx}-${cIdx}-Load" value="${c.Load}" class="w-full border p-1 rounded"></label></div><div class="grid grid-cols-3 gap-3 text-xs"><label>L<input type="number" id="cube-${sIdx}-${cIdx}-L" value="${c.L}" class="w-full border p-1 rounded"></label><label>B<input type="number" id="cube-${sIdx}-${cIdx}-B" value="${c.B}" class="w-full border p-1 rounded"></label><label>H<input type="number" id="cube-${sIdx}-${cIdx}-H" value="${c.H}" class="w-full border p-1 rounded"></label></div><label class="text-xs">Weight (kg)<input type="number" id="cube-${sIdx}-${cIdx}-W" value="${c.W}" step="0.01" class="w-full border p-1 rounded"></label><div class="grid grid-cols-3 gap-2 text-[10px] pt-1 border-t"><span>D: <span id="cube-${sIdx}-${cIdx}-density">0</span></span><span>S: <span id="cube-${sIdx}-${cIdx}-strength">0</span></span><span>Var: <span id="cube-${sIdx}-${cIdx}-p-variation">0%</span></span></div>`;
                    div.querySelector(`#sample-cubes-${sIdx}`).appendChild(cubeDiv);
                    ['id', 'L', 'B', 'H', 'W', 'Load'].forEach(f => {
                        document.getElementById(`cube-${sIdx}-${cIdx}-${f}`).addEventListener('input', e => handleCubeInput(sIdx, cIdx, f === 'id' ? 'ID' : f, e.target.value));
                    });
                });
                if (recalc) calculateSampleMetrics(sIdx);
            });
        }

        function calculateFinalResults(isLoad = false) {
            state.samples.forEach((_, i) => calculateSampleMetrics(i));
            const strengths = state.samples.filter(s => s.acceptable).map(s => s.avgStrength);
            state.meanStrength = strengths.length ? strengths.reduce((a, b) => a + b) / strengths.length : 0;
            state.minStrength = strengths.length ? Math.min(...strengths) : 0;
            const fck = state.concreteGrade, Q = state.quantity;
            if (state.isPwdWork) {
                state.sd = 0;
                if (Q > 30) { state.requiredMean = fck + 3; state.requiredMin = fck - 3; }
                else if (Q >= 6) { state.requiredMean = fck + 4; state.requiredMin = fck - 2; }
                else { state.requiredMean = fck + 4; state.requiredMin = 0; }
            } else {
                state.sd = fck < 20 ? 3 : (fck <= 30 ? 4 : 5);
                state.requiredMean = fck + Math.max(4, 0.825 * state.sd); state.requiredMin = fck - 4;
            }
            state.verdict = (strengths.length > 0 && state.meanStrength >= state.requiredMean && (Q < 6 || state.minStrength >= state.requiredMin)) ? 'PASS' : 'FAIL';
            updateResultsCard('results-card'); document.getElementById('results-card').classList.remove('hidden');
            if (!isLoad) navigateTo(3);
        }

        function updateResultsCard(prefix) {
            const Q = state.quantity;
            document.getElementById(`${prefix}-mean-strength`).textContent = state.meanStrength.toFixed(2);
            document.getElementById(`${prefix}-min-strength`).textContent = state.minStrength.toFixed(2);
            document.getElementById(`${prefix}-required-mean`).textContent = state.requiredMean.toFixed(2);
            document.getElementById(`${prefix}-required-min`).textContent = state.requiredMin.toFixed(2);
            const v = document.getElementById(`${prefix}-final-verdict`);
            v.textContent = state.verdict; v.className = state.verdict === 'PASS' ? 'text-green-600 font-extrabold' : 'text-red-600 font-extrabold';
            const sd = document.getElementById(`${prefix}-sd`); if (sd) { sd.textContent = state.sd; sd.parentElement.classList.toggle('hidden', state.isPwdWork); }
            const mLabel = document.getElementById(`${prefix}-required-mean-label`), minLabel = document.getElementById(`${prefix}-required-min-label`);
            if (state.isPwdWork) {
                mLabel.textContent = Q > 30 ? 'Required Mean (fck+3)' : 'Required Mean (fck+4)';
                minLabel.textContent = Q > 30 ? 'Required Min (fck-3)' : (Q >= 6 ? 'Required Min (fck-2)' : 'Required Min (N/A)');
            } else { mLabel.textContent = 'Required Mean (IS 456)'; minLabel.textContent = 'Required Min (IS 456)'; }
        }

        function updateScreen3UI() {
            ['ref-no', 'client-name', 'project-name', 'location', 'concrete-grade', 'mix-type', 'quantity', 'num-samples', 'date-casting', 'date-testing', 'age-specimen'].forEach(id => {
                document.getElementById(`sum-${id}`).textContent = state[id.replace(/-([a-z])/g, g => g[1].toUpperCase())];
            });
            document.getElementById('sum-references').textContent = state.referenceStandard + (state.isPwdWork ? ', TC CE/DESIGN/QC/15/2019' : '');
            updateResultsCard('sum-card');
            const body = document.querySelector('#sum-data-table tbody'); body.innerHTML = '';
            state.samples.forEach((s, sIdx) => {
                s.cubes.forEach((c, cIdx) => {
                    const r = body.insertRow(); if (cIdx === 2) r.className = 'border-b border-gray-400';
                    if (cIdx === 0) { const cell = r.insertCell(); cell.rowSpan = 3; cell.textContent = `S-${sIdx + 1}`; cell.className = 'bg-gray-100 font-bold border-r align-middle'; }
                    [c.id, c.L.toFixed(0), c.B.toFixed(0), c.H.toFixed(0), c.W.toFixed(2), c.Load.toFixed(2)].forEach(v => r.insertCell().textContent = v);
                    const d = r.insertCell(); d.textContent = c.density.toFixed(2); d.className = 'bg-yellow-100';
                    const st = r.insertCell(); st.textContent = c.strength.toFixed(2); st.className = 'bg-yellow-100';
                    const v = r.insertCell(); v.textContent = `${c.percentVariation.toFixed(2)}%`; v.className = `bg-yellow-100 ${Math.abs(c.percentVariation) > 15 ? 'text-red-600' : 'text-green-600'}`;
                    if (cIdx === 0) {
                        const avg = r.insertCell(); avg.rowSpan = 3; avg.textContent = s.avgStrength.toFixed(2); avg.className = 'bg-blue-100 font-bold align-middle';
                        const acc = r.insertCell(); acc.rowSpan = 3; acc.textContent = s.acceptable ? 'YES' : 'NO'; acc.className = `bg-blue-100 font-bold align-middle ${s.acceptable ? 'text-green-700' : 'text-red-700'}`;
                    }
                });
            });
            const btn = document.getElementById('export-pdf-btn3'); btn.disabled = !pdfLibrariesReady || state.verdict === 'PENDING';
            btn.onclick = generatePDF;
        }

        // --- UPDATED: GENERATE PDF WITH NOTES AND SIGNATURES ---
        function generatePDF() {
            if (!pdfLibrariesReady) return showToast('Loading libraries...', 'red');
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a4');
            const docWidth = doc.internal.pageSize.getWidth(), pageHeight = doc.internal.pageSize.getHeight(), margin = 15;
            let y = 15;

            // Header
            doc.setFont('helvetica', 'bold').setFontSize(14);
            doc.text("COLLEGE OF ENGINEERING PATHANAPURAM", docWidth/2, y, { align: 'center' }); y += 5;
            doc.setFont('helvetica', 'normal').setFontSize(10);
            doc.text("CAPE, Govt of Kerala", docWidth/2, y, { align: 'center' }); y += 4;
            doc.text("Elikkatoor P.O, Kollam, Kerala Pin 689696", docWidth/2, y, { align: 'center' }); y += 4;
            doc.text("Phone : 0475-2022810, FAX: 0475-2225959", docWidth/2, y, { align: 'center' }); y += 6;
            doc.setFont('helvetica', 'bold').setFontSize(12);
            doc.text("MATERIAL TESTING LABORATORY-II", docWidth/2, y, { align: 'center' }); y += 7;
            doc.text("Concrete Cube Compressive Strength Report", docWidth/2, y, { align: 'center' }); y += 5;
            doc.setFont('helvetica', 'normal').setFontSize(10);
            doc.text(`Reference Standard: ${state.referenceStandard}${state.isPwdWork ? ', Kerala PWD TC CE/DESIGN/QC/15/2019' : ''}`, docWidth/2, y, { align: 'center' }); y += 10;

            // Details
            doc.setFont(undefined, 'bold').text("Project Details", margin, y); y += 5;
            doc.setFont(undefined, 'normal');
            doc.text(`Reference No: ${state.refNo}`, margin, y); y += 5;
            doc.text(`Client: ${state.clientName}`, margin, y); y += 5;
            doc.text(`Project: ${state.projectName}`, margin, y); y += 5;
            doc.text(`Location: ${state.location}`, margin, y); y += 5;
            doc.text(`Casting Date: ${state.dateCasting}`, margin, y);
            doc.text(`Testing Date: ${state.dateTesting}`, margin + 120, y); y += 5;
            doc.text(`Grade: M${state.concreteGrade}`, margin, y);
            doc.text(`Age: ${state.ageSpecimen} Days`, margin + 120, y); y += 5;

            // Verdict Section
            doc.setFont(undefined, 'bold').text(`Minimum Strength: ${state.minStrength.toFixed(2)} N/mm2`, margin, y);
            doc.text(`Mean Strength: ${state.meanStrength.toFixed(2)} N/mm2`, margin + 120, y); y += 5;

            // Table
            const rows = [];
            state.samples.forEach((s, sIdx) => {
                s.cubes.forEach((c, cIdx) => {
                    rows.push([`S-${sIdx+1}`, c.id, c.L, c.B, c.H, c.W.toFixed(2), c.Load.toFixed(2), c.density.toFixed(2), c.strength.toFixed(2), `${c.percentVariation.toFixed(2)}%`, s.avgStrength.toFixed(2), s.acceptable ? 'YES' : 'NO']);
                });
            });

            doc.autoTable({
                startY: y, head: [['Sample', 'Cube ID', 'L', 'B', 'H', 'W(kg)', 'Load(kN)', 'Density', 'Strength', '% Var', 'Avg', 'Accept']],
                body: rows, theme: 'grid', styles: { fontSize: 8, halign: 'center' }, headStyles: { fillColor: [52, 73, 94] }
            });

            y = doc.lastAutoTable.finalY + 12;

            // CHECK PAGE SPACE FOR NOTES
            if (y + 60 > pageHeight) { doc.addPage(); y = 20; }

            // Notes Section (As in image)
            doc.setFont(undefined, 'bold').setFontSize(11).text("Note:", margin, y); y += 6;
            doc.setFont(undefined, 'normal').setFontSize(10);
            const notes = [
                "1. All the tests were performed according to relevant IS Specification.",
                "2. The results are based only on the samples provided by the client and College of Engineering Pathanapuram is in no way involved in the sampling process",
                "3. This report is being issued on the specific understanding that College of Engineering Pathanapuram is in no way involved in any action following the interpretation of the above results."
            ];
            notes.forEach(n => {
                const split = doc.splitTextToSize(n, docWidth - 30);
                doc.text(split, margin, y); y += (split.length * 5);
            });

            // Signing Space (As in image)
            y += 25;
            const sigW = 60, space = (docWidth - 30 - (sigW * 3)) / 2;
            const sigs = [{ x: margin, l: "PI" }, { x: margin + sigW + space, l: "HoD CE" }, { x: margin + (sigW + space) * 2, l: "Principal" }];
            sigs.forEach(s => {
                doc.line(s.x, y, s.x + sigW, y);
                doc.setFont(undefined, 'bold').text(s.l, s.x + (sigW/2), y + 6, { align: 'center' });
            });

            doc.save(`${state.projectName.replace(/\s+/g, '_')}_Report.pdf`);
        }

        // --- INIT ---
        (function() {
            showLoading(); checkPdfLibraries(); setDefaultDates(); initializeFirebase();
            ['ref-no', 'client-name','project-name', 'location', 'concrete-grade', 'mix-type', 'quantity', 'num-samples', 'date-casting', 'date-testing', 'reference-standard', 'is-pwd-work'].forEach(id => {
                document.getElementById(id).addEventListener('input', e => {
                    const val = e.target.type === 'checkbox' ? e.target.checked : (e.target.type === 'number' ? parseFloat(e.target.value) || 0 : e.target.value);
                    state[id.replace(/-([a-z])/g, g => g[1].toUpperCase())] = val;
                    if (id === 'quantity') updateMinSamplesInfo();
                    if (id.startsWith('date')) updateAgeSpecimen();
                });
            });
            document.getElementById('next-screen-btn').onclick = () => { if (state.ageSpecimen > 0 && state.numSamples > 0) { updateScreen2UI(); navigateTo(2); } else showToast('Check inputs', 'red'); };
            document.getElementById('save-data-btn1').onclick = saveState;
            document.getElementById('load-data-btn').onclick = () => loadState(false);
            document.getElementById('back-screen-btn').onclick = () => navigateTo(1);
            document.getElementById('save-data-btn2').onclick = saveState;
            document.getElementById('calculate-results-btn').onclick = () => calculateFinalResults(false);
            document.getElementById('nav-step1').onclick = () => navigateTo(1);
            document.getElementById('nav-step2').onclick = () => navigateTo(2);
            document.getElementById('nav-step3').onclick = () => navigateTo(3);
            document.getElementById('back-screen2-btn').onclick = () => navigateTo(2);
            navigateTo(1);
        })();
    }
    </script>
</body>
</html>
